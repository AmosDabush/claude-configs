[
  {
    "timestamp": "2025-12-17T09:01:45.049Z",
    "db": "dev",
    "sql": "\n-- Final verification\nSELECT 'total_surgery_waiting' as metric, COUNT(*) as count FROM patients.surgery_waiting\nUNION ALL\nSELECT 'distinct_case_ids', COUNT(DISTINCT case_id) FROM patients.surgery_waiting\nUNION ALL\nSELECT 'with_matching_case', COUNT(*) FROM patients.surgery_waiting sw \nJOIN patients.cases c ON sw.case_id = c.case_id\nUNION ALL\nSELECT 'orphaned_no_case', COUNT(*) FROM patients.surgery_waiting sw \nLEFT JOIN patients.cases c ON sw.case_id = c.case_id\nWHERE c.case_id IS NULL\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T09:01:38.189Z",
    "db": "dev",
    "sql": "\n-- Step 2: Remove duplicate surgery_waiting records, keeping the one with lowest id per case_id\nDELETE FROM patients.surgery_waiting\nWHERE id NOT IN (\n    SELECT MIN(id)\n    FROM patients.surgery_waiting\n    GROUP BY case_id\n);\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T09:01:30.219Z",
    "db": "dev",
    "sql": "\n-- Verify: count surgery_waiting with and without matching cases now\nSELECT 'with_matching_case' as metric, COUNT(*) as count \nFROM patients.surgery_waiting sw \nJOIN patients.cases c ON sw.case_id = c.case_id\nUNION ALL\nSELECT 'orphaned_no_case', COUNT(*) \nFROM patients.surgery_waiting sw \nLEFT JOIN patients.cases c ON sw.case_id = c.case_id\nWHERE c.case_id IS NULL\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T09:01:22.555Z",
    "db": "dev",
    "sql": "\n-- Step 2: Create cases for orphaned caseIds (case_id is integer)\nINSERT INTO patients.cases (case_id, patient_id, nursing_ward, mabar_code, is_active, admission_date, update_date, chameleon_ward_id)\nSELECT \n    case_id as case_id,\n    case_id as patient_id,\n    'כירורגיה' as nursing_ward,\n    'SURG' as mabar_code,\n    true as is_active,\n    NOW() - interval '3 days' as admission_date,\n    NOW() as update_date,\n    '10' as chameleon_ward_id\nFROM (\n    SELECT DISTINCT sw.case_id\n    FROM patients.surgery_waiting sw \n    LEFT JOIN patients.cases c ON sw.case_id = c.case_id\n    WHERE c.case_id IS NULL\n) orphans\nON CONFLICT (case_id) DO NOTHING;\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T09:01:16.073Z",
    "db": "dev",
    "sql": "\n-- Check cases table structure for case_id\nSELECT column_name, data_type \nFROM information_schema.columns \nWHERE table_schema = 'patients' AND table_name = 'cases' AND column_name = 'case_id'\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T09:01:02.173Z",
    "db": "dev",
    "sql": "\n-- Step 1: Create patients for orphaned caseIds\nINSERT INTO patients.patients (patient_id, id_number, first_name, last_name, full_name, birth_date, sex, update_date)\nSELECT \n    case_id as patient_id,\n    case_id::varchar as id_number,\n    CASE (ROW_NUMBER() OVER (ORDER BY case_id) % 10)\n        WHEN 0 THEN 'יוסף'\n        WHEN 1 THEN 'דוד'\n        WHEN 2 THEN 'משה'\n        WHEN 3 THEN 'שרה'\n        WHEN 4 THEN 'רחל'\n        WHEN 5 THEN 'לאה'\n        WHEN 6 THEN 'אברהם'\n        WHEN 7 THEN 'יעקב'\n        WHEN 8 THEN 'מרים'\n        WHEN 9 THEN 'חנה'\n    END as first_name,\n    CASE (ROW_NUMBER() OVER (ORDER BY case_id) % 8)\n        WHEN 0 THEN 'כהן'\n        WHEN 1 THEN 'לוי'\n        WHEN 2 THEN 'מזרחי'\n        WHEN 3 THEN 'פרץ'\n        WHEN 4 THEN 'ביטון'\n        WHEN 5 THEN 'אברהם'\n        WHEN 6 THEN 'דהן'\n        WHEN 7 THEN 'אזולאי'\n    END as last_name,\n    CASE (ROW_NUMBER() OVER (ORDER BY case_id) % 10)\n        WHEN 0 THEN 'יוסף'\n        WHEN 1 THEN 'דוד'\n        WHEN 2 THEN 'משה'\n        WHEN 3 THEN 'שרה'\n        WHEN 4 THEN 'רחל'\n        WHEN 5 THEN 'לאה'\n        WHEN 6 THEN 'אברהם'\n        WHEN 7 THEN 'יעקב'\n        WHEN 8 THEN 'מרים'\n        WHEN 9 THEN 'חנה'\n    END || ' ' ||\n    CASE (ROW_NUMBER() OVER (ORDER BY case_id) % 8)\n        WHEN 0 THEN 'כהן'\n        WHEN 1 THEN 'לוי'\n        WHEN 2 THEN 'מזרחי'\n        WHEN 3 THEN 'פרץ'\n        WHEN 4 THEN 'ביטון'\n        WHEN 5 THEN 'אברהם'\n        WHEN 6 THEN 'דהן'\n        WHEN 7 THEN 'אזולאי'\n    END as full_name,\n    '1970-01-01'::date + (case_id % 15000 || ' days')::interval as birth_date,\n    CASE WHEN ROW_NUMBER() OVER (ORDER BY case_id) % 2 = 0 THEN 'ז' ELSE 'נ' END as sex,\n    NOW() as update_date\nFROM (\n    SELECT DISTINCT sw.case_id\n    FROM patients.surgery_waiting sw \n    LEFT JOIN patients.cases c ON sw.case_id::varchar = c.case_id::varchar\n    WHERE c.case_id IS NULL\n) orphans\nON CONFLICT (patient_id) DO NOTHING;\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T09:00:48.410Z",
    "db": "dev",
    "sql": "\n-- Get all distinct orphaned caseIds that need cases/patients created\nSELECT DISTINCT sw.case_id\nFROM patients.surgery_waiting sw \nLEFT JOIN patients.cases c ON sw.case_id::varchar = c.case_id::varchar\nWHERE c.case_id IS NULL\nORDER BY sw.case_id\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T08:57:25.621Z",
    "db": "dev",
    "sql": "\n-- Sample orphaned caseIds\nSELECT sw.case_id, COUNT(*) as occurrences\nFROM patients.surgery_waiting sw \nLEFT JOIN patients.cases c ON sw.case_id::varchar = c.case_id::varchar\nWHERE c.case_id IS NULL\nGROUP BY sw.case_id\nORDER BY occurrences DESC\nLIMIT 10\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-17T08:57:12.903Z",
    "db": "dev",
    "sql": "\n-- Total surgery_waiting records\nSELECT 'total_surgery_waiting' as metric, COUNT(*) as count FROM patients.surgery_waiting\nUNION ALL\n-- Surgery waiting with matching cases\nSELECT 'with_matching_case', COUNT(*) FROM patients.surgery_waiting sw \nJOIN patients.cases c ON sw.case_id::varchar = c.case_id::varchar\nUNION ALL\n-- Surgery waiting WITHOUT matching cases  \nSELECT 'orphaned_no_case', COUNT(*) FROM patients.surgery_waiting sw \nLEFT JOIN patients.cases c ON sw.case_id::varchar = c.case_id::varchar\nWHERE c.case_id IS NULL\nUNION ALL\n-- Distinct caseIds in surgery_waiting\nSELECT 'distinct_case_ids', COUNT(DISTINCT case_id) FROM patients.surgery_waiting\n",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:58:52.780Z",
    "db": "dev",
    "sql": "SELECT chameleon_ward_id, COUNT(*) as count FROM patients.cases GROUP BY chameleon_ward_id ORDER BY chameleon_ward_id",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:58:46.893Z",
    "db": "dev",
    "sql": "UPDATE patients.cases SET chameleon_ward_id = '11' WHERE case_id IN (SELECT case_id FROM patients.cases WHERE chameleon_ward_id IS NULL ORDER BY case_id LIMIT 19)",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:58:45.721Z",
    "db": "dev",
    "sql": "UPDATE patients.cases SET chameleon_ward_id = '10' WHERE case_id IN (SELECT case_id FROM patients.cases ORDER BY case_id LIMIT 20)",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:46.538Z",
    "db": "dev",
    "sql": "SELECT case_id, chameleon_ward_id, chameleon_satellite_ward_id FROM patients.cases LIMIT 5",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:45.375Z",
    "db": "dev",
    "sql": "SELECT COUNT(*) as total_cases FROM patients.cases",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:38.720Z",
    "db": "dev",
    "sql": "SELECT DISTINCT chameleon_ward_id, COUNT(*) as case_count FROM patients.cases WHERE chameleon_ward_id IS NOT NULL GROUP BY chameleon_ward_id ORDER BY case_count DESC LIMIT 15",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:29.711Z",
    "db": "dev",
    "sql": "SELECT ward_id, system_num FROM common.wards WHERE ward_id IN ('10', '11')",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:28.535Z",
    "db": "dev",
    "sql": "SELECT DISTINCT chameleon_ward_id, COUNT(*) as cases FROM patients.cases WHERE chameleon_ward_id IN ('10', '11') GROUP BY chameleon_ward_id",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:27.344Z",
    "db": "dev",
    "sql": "SELECT system_num, system_name FROM common.source_system WHERE system_name = 'CHAMELEON'",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:06.986Z",
    "db": "dev",
    "sql": "SELECT ward_id, ward_long_desc, ward_category, is_internally FROM common.wards WHERE ward_category IS NOT NULL LIMIT 10",
    "env": "local"
  },
  {
    "timestamp": "2025-12-16T19:57:05.825Z",
    "db": "dev",
    "sql": "SELECT DISTINCT ward_category, COUNT(*) as count FROM common.wards GROUP BY ward_category ORDER BY ward_category",
    "env": "local"
  }
]